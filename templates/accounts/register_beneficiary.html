{% extends 'base.html' %}

{% block title %}Register as Beneficiary - Resource Match{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Register as Beneficiary</h3>
            </div>
            <div class="card-body">
                <form method="post" novalidate>
                    {% csrf_token %}
                    
                    <h4 class="mb-3">Account Information</h4>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.username.id_for_label }}" class="form-label">Username</label>
                            <input type="text" name="{{ form.username.name }}" id="{{ form.username.id_for_label }}" 
                                   class="form-control {% if form.username.errors %}is-invalid{% endif %}" 
                                   value="{{ form.username.value|default:'' }}">
                            {% if form.username.errors %}
                                <div class="invalid-feedback">{{ form.username.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.email.id_for_label }}" class="form-label">Email</label>
                            <input type="email" name="{{ form.email.name }}" id="{{ form.email.id_for_label }}" 
                                   class="form-control {% if form.email.errors %}is-invalid{% endif %}" 
                                   value="{{ form.email.value|default:'' }}">
                            {% if form.email.errors %}
                                <div class="invalid-feedback">{{ form.email.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.password1.id_for_label }}" class="form-label">Password</label>
                            <input type="password" name="{{ form.password1.name }}" id="{{ form.password1.id_for_label }}" 
                                   class="form-control {% if form.password1.errors %}is-invalid{% endif %}">
                            {% if form.password1.errors %}
                                <div class="invalid-feedback">{{ form.password1.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.password2.id_for_label }}" class="form-label">Confirm Password</label>
                            <input type="password" name="{{ form.password2.name }}" id="{{ form.password2.id_for_label }}" 
                                   class="form-control {% if form.password2.errors %}is-invalid{% endif %}">
                            {% if form.password2.errors %}
                                <div class="invalid-feedback">{{ form.password2.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <h4 class="mb-3 mt-4">Personal Information</h4>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.first_name.id_for_label }}" class="form-label">First Name</label>
                            <input type="text" name="{{ form.first_name.name }}" id="{{ form.first_name.id_for_label }}" 
                                   class="form-control {% if form.first_name.errors %}is-invalid{% endif %}" 
                                   value="{{ form.first_name.value|default:'' }}">
                            {% if form.first_name.errors %}
                                <div class="invalid-feedback">{{ form.first_name.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.last_name.id_for_label }}" class="form-label">Last Name</label>
                            <input type="text" name="{{ form.last_name.name }}" id="{{ form.last_name.id_for_label }}" 
                                   class="form-control {% if form.last_name.errors %}is-invalid{% endif %}" 
                                   value="{{ form.last_name.value|default:'' }}">
                            {% if form.last_name.errors %}
                                <div class="invalid-feedback">{{ form.last_name.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.phone_number.id_for_label }}" class="form-label">Phone Number</label>
                            <input type="tel" name="{{ form.phone_number.name }}" id="{{ form.phone_number.id_for_label }}" 
                                   class="form-control {% if form.phone_number.errors %}is-invalid{% endif %}" 
                                   value="{{ form.phone_number.value|default:'' }}">
                            {% if form.phone_number.errors %}
                                <div class="invalid-feedback">{{ form.phone_number.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ beneficiary_form.mobility_limitations.id_for_label }}" class="form-label">Mobility Limitations</label>
                            <div class="form-check">
                                <input type="checkbox" name="{{ beneficiary_form.mobility_limitations.name }}" 
                                       id="{{ beneficiary_form.mobility_limitations.id_for_label }}" 
                                       class="form-check-input {% if beneficiary_form.mobility_limitations.errors %}is-invalid{% endif %}" 
                                       {% if beneficiary_form.mobility_limitations.value %}checked{% endif %}>
                                <label class="form-check-label" for="{{ beneficiary_form.mobility_limitations.id_for_label }}">
                                    I have mobility limitations
                                </label>
                                {% if beneficiary_form.mobility_limitations.errors %}
                                    <div class="invalid-feedback">{{ beneficiary_form.mobility_limitations.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.address.id_for_label }}" class="form-label">Address</label>
                        <input type="text" name="{{ form.address.name }}" id="{{ form.address.id_for_label }}" 
                               class="form-control {% if form.address.errors %}is-invalid{% endif %}" 
                               value="{{ form.address.value|default:'' }}">
                        {% if form.address.errors %}
                            <div class="invalid-feedback">{{ form.address.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ beneficiary_form.needs_description.id_for_label }}" class="form-label">Describe Your Needs</label>
                        <textarea name="{{ beneficiary_form.needs_description.name }}" 
                                  id="{{ beneficiary_form.needs_description.id_for_label }}" 
                                  class="form-control {% if beneficiary_form.needs_description.errors %}is-invalid{% endif %}" 
                                  rows="3">{{ beneficiary_form.needs_description.value|default:'' }}</textarea>
                        {% if beneficiary_form.needs_description.errors %}
                            <div class="invalid-feedback">{{ beneficiary_form.needs_description.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <h4 class="mb-3 mt-4">Emergency Contact</h4>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ beneficiary_form.emergency_contact_name.id_for_label }}" class="form-label">Emergency Contact Name</label>
                            <input type="text" name="{{ beneficiary_form.emergency_contact_name.name }}" 
                                   id="{{ beneficiary_form.emergency_contact_name.id_for_label }}" 
                                   class="form-control {% if beneficiary_form.emergency_contact_name.errors %}is-invalid{% endif %}" 
                                   value="{{ beneficiary_form.emergency_contact_name.value|default:'' }}">
                            {% if beneficiary_form.emergency_contact_name.errors %}
                                <div class="invalid-feedback">{{ beneficiary_form.emergency_contact_name.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ beneficiary_form.emergency_contact_phone.id_for_label }}" class="form-label">Emergency Contact Phone</label>
                            <input type="tel" name="{{ beneficiary_form.emergency_contact_phone.name }}" 
                                   id="{{ beneficiary_form.emergency_contact_phone.id_for_label }}" 
                                   class="form-control {% if beneficiary_form.emergency_contact_phone.errors %}is-invalid{% endif %}" 
                                   value="{{ beneficiary_form.emergency_contact_phone.value|default:'' }}">
                            {% if beneficiary_form.emergency_contact_phone.errors %}
                                <div class="invalid-feedback">{{ beneficiary_form.emergency_contact_phone.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="terms" required>
                            <label class="form-check-label" for="terms">
                                I agree to the <a href="{% url 'terms' %}" target="_blank">Terms of Service</a> and <a href="{% url 'privacy' %}" target="_blank">Privacy Policy</a>
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">Register as Beneficiary</button>
                    </div>
                </form>
                
                <div class="text-center mt-3">
                    <p>Already have an account? <a href="{% url 'login' %}">Login here</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get the address input field
    const addressInput = document.getElementById('{{ form.address.id_for_label }}');
    
    // Initialize the map (hidden initially)
    const mapDiv = document.createElement('div');
    mapDiv.id = 'location-map';
    mapDiv.style.height = '300px';
    mapDiv.style.marginTop = '10px';
    mapDiv.style.display = 'none';
    
    // Insert the map after the address input
    addressInput.parentNode.insertBefore(mapDiv, addressInput.nextSibling);
    
    // Create a button to get current location
    const locationBtn = document.createElement('button');
    locationBtn.type = 'button';
    locationBtn.className = 'btn btn-outline-secondary mt-2';
    locationBtn.innerHTML = '<i class="bi bi-geo-alt"></i> Use My Current Location';
    
    // Insert the button after the map
    addressInput.parentNode.insertBefore(locationBtn, mapDiv.nextSibling);
    
    // Initialize the map
    const map = L.map('location-map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    let marker;
    
    // Function to update the map with a location
    function updateMap(lat, lng, address) {
        mapDiv.style.display = 'block';
        map.setView([lat, lng], 15);
        
        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng]).addTo(map);
        }
        
        if (address) {
            addressInput.value = address;
        }
        
        // Add hidden inputs for latitude and longitude
        let latInput = document.getElementById('id_latitude');
        let lngInput = document.getElementById('id_longitude');
        
        if (!latInput) {
            latInput = document.createElement('input');
            latInput.type = 'hidden';
            latInput.name = 'latitude';
            latInput.id = 'id_latitude';
            addressInput.parentNode.appendChild(latInput);
        }
        
        if (!lngInput) {
            lngInput = document.createElement('input');
            lngInput.type = 'hidden';
            lngInput.name = 'longitude';
            lngInput.id = 'id_longitude';
            addressInput.parentNode.appendChild(lngInput);
        }
        
        latInput.value = lat;
        lngInput.value = lng;
    }
    
    // Get current location when the button is clicked
    locationBtn.addEventListener('click', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Reverse geocode to get address
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                        .then(response => response.json())
                        .then(data => {
                            const address = data.display_name;
                            updateMap(lat, lng, address);
                        })
                        .catch(error => {
                            console.error('Error getting address:', error);
                            updateMap(lat, lng);
                        });
                },
                function(error) {
                    console.error('Error getting location:', error);
                    alert('Unable to get your location. Please enter your address manually.');
                }
            );
        } else {
            alert('Geolocation is not supported by your browser. Please enter your address manually.');
        }
    });
    
    // Geocode address when it changes
    addressInput.addEventListener('blur', function() {
        const address = addressInput.value.trim();
        if (address) {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lng = parseFloat(data[0].lon);
                        updateMap(lat, lng);
                    } else {
                        mapDiv.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error geocoding address:', error);
                    mapDiv.style.display = 'none';
                });
        } else {
            mapDiv.style.display = 'none';
        }
    });
});
</script>
{% endblock %}

